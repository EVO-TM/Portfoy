<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Evo | Cardboard Dashboard</title>
  <link rel="icon" type="image/png" href="evo_logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* =========================================
       CARDBOARD & NEOBRUTALISM THEME
       ========================================= */
    :root {
      --paper-bg: #e6daca;
      --cardboard-light: #f4e8d8;
      --cardboard-main: #e2cfae;
      --cardboard-dark: #c9af88;
      --ink: #2b1f1a;
      --ink-light: #524036;
      --marker-red: #ff4b4b;
      --marker-green: #10b981;
      --marker-blue: #3b82f6;
      --marker-yellow: #f59e0b;
      --tape-bg: rgba(245, 245, 220, 0.85);
      
      --border-thick: 3px solid var(--ink);
      --border-thin: 2px solid var(--ink);
      --shadow-solid: 6px 6px 0px var(--ink);
      --shadow-hover: 2px 2px 0px var(--ink);
      --radius: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background-color: var(--paper-bg);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    h1, h2, h3 { font-family: 'Outfit', sans-serif; font-weight: 900; letter-spacing: -0.5px; }

    /* LAYOUT */
    .container { width: 100%; max-width: 1200px; }

    .panel {
      background: var(--cardboard-light);
      border: var(--border-thick);
      border-radius: var(--radius);
      box-shadow: 12px 12px 0px var(--ink);
      display: flex; flex-direction: column;
      min-height: 90vh; position: relative;
    }

    .topbar {
      background: var(--cardboard-main);
      padding: 20px 30px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: var(--border-thick);
    }

    .brand { font-size: 26px; font-weight: 900; display: flex; align-items: center; gap: 10px; font-family: 'Outfit', sans-serif; }
    .brand i { color: var(--marker-red); }

    .content { padding: 30px; flex: 1; overflow-y: auto; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; }

    /* CARDBOARD CARDS WITH MASKING TAPE */
    .card {
      background: var(--cardboard-light);
      border: var(--border-thick);
      border-radius: var(--radius);
      padding: 30px 25px 25px;
      box-shadow: var(--shadow-solid);
      position: relative;
    }
    
    .tape {
      position: absolute;
      top: -12px; left: 50%;
      transform: translateX(-50%) rotate(-2deg);
      width: 120px; height: 28px;
      background: var(--tape-bg);
      border: 1px dashed rgba(0,0,0,0.2);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10; backdrop-filter: blur(2px);
    }
    .card:nth-child(even) .tape { transform: translateX(-50%) rotate(3deg); }

    .card-header { margin-bottom: 20px; border-bottom: 2px dashed var(--ink-light); padding-bottom: 10px; }
    .card-header p { color: var(--ink-light); font-size: 13px; font-weight: 600; margin-top: 5px; }

    /* FORMS & INPUTS */
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 700; font-size: 14px; margin-bottom: 8px; color: var(--ink); }
    
    input[type="text"], input[type="password"], select, textarea {
      width: 100%; padding: 12px 15px;
      background: #fff;
      border: var(--border-thin);
      border-radius: var(--radius);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px; font-weight: 600;
      color: var(--ink);
      box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
      outline: none; transition: 0.1s;
    }
    input:focus, textarea:focus, select:focus {
      box-shadow: var(--shadow-solid); transform: translate(-2px, -2px); background: #fffcf5;
    }
    textarea { min-height: 100px; resize: vertical; }

    /* FILE UPLOAD (Marker Style) */
    .file-upload {
      border: 3px dashed var(--ink);
      border-radius: var(--radius);
      padding: 15px; text-align: center; cursor: pointer;
      background: rgba(255,255,255,0.5);
      position: relative; overflow: hidden; transition: 0.2s; font-weight: 700;
    }
    .file-upload:hover { background: var(--cardboard-main); }
    .file-upload input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .file-name-display { font-size: 12px; color: var(--marker-blue); font-weight: 800; margin-top: 8px; word-break: break-all; }

    /* BUTTONS */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 12px 20px; border: var(--border-thick); border-radius: var(--radius);
      font-weight: 800; font-size: 15px; cursor: pointer;
      box-shadow: var(--shadow-solid);
      transition: all 0.1s ease-in-out; text-decoration: none; color: var(--ink);
    }
    .btn:active { box-shadow: 0px 0px 0px var(--ink); transform: translate(6px, 6px); }
    
    .btn-primary { background: var(--marker-yellow); }
    .btn-primary:hover { background: #fbbf24; }
    .btn-danger { background: var(--marker-red); color: white; }
    .btn-danger:hover { background: #ef4444; }
    .btn-outline { background: #fff; }
    .btn-outline:hover { background: var(--cardboard-main); }
    .btn-row { display: flex; gap: 15px; margin-top: 15px; }

    /* LISTS & ITEMS */
    .list-container { margin-top: 25px; max-height: 380px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding-right: 10px; }
    .list-container::-webkit-scrollbar { width: 8px; }
    .list-container::-webkit-scrollbar-thumb { background: var(--ink); border-radius: 4px; }

    .item {
      display: flex; gap: 15px; background: #fff;
      border: var(--border-thin); border-radius: var(--radius);
      padding: 15px; align-items: flex-start;
      box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
    }
    .item-thumb {
      width: 70px; height: 70px; border-radius: var(--radius);
      background: var(--ink); flex-shrink: 0; overflow: hidden;
      display: flex; align-items: center; justify-content: center; border: 2px solid var(--ink);
    }
    .item-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .item-thumb i { font-size: 28px; color: var(--cardboard-light); }
    
    .item-info { flex: 1; min-width: 0; }
    .item-title { font-weight: 800; font-size: 16px; color: var(--ink); }
    .item-meta { font-size: 12px; color: var(--ink-light); margin-top: 4px; font-weight: 600; }
    .item-badge { display: inline-block; padding: 4px 8px; background: var(--cardboard-main); border: 2px solid var(--ink); border-radius: 4px; font-size: 11px; font-weight: 800; margin-top: 6px; }

    .item-actions { display: flex; gap: 8px; flex-direction: column; }
    .btn-icon { width: 36px; height: 36px; border: var(--border-thin); border-radius: var(--radius); background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.1s; box-shadow: 2px 2px 0px var(--ink); }
    .btn-icon:active { box-shadow: 0 0 0 var(--ink); transform: translate(2px, 2px); }
    .btn-edit { color: var(--marker-blue); }
    .btn-del { color: var(--marker-red); }

    /* LOGIN SCREEN */
    .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; }
    .login-box { width: 100%; max-width: 420px; text-align: center; }
    .login-icon { font-size: 56px; color: var(--ink); margin-bottom: 10px; }

    /* LOADER & TOASTS */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(230, 218, 202, 0.9); backdrop-filter: blur(4px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; display: none;
    }
    .spinner { border: 5px solid var(--cardboard-dark); border-top: 5px solid var(--ink); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: #fff; border: var(--border-thick); padding: 15px 20px;
      border-radius: var(--radius); box-shadow: var(--shadow-solid);
      display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 14px;
      animation: slideIn 0.3s forwards;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* MODAL */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(43, 31, 26, 0.8); backdrop-filter: blur(3px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; pointer-events: none; transition: 0.2s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: var(--cardboard-light); width: 100%; max-width: 500px;
      border: var(--border-thick); border-radius: var(--radius);
      padding: 30px; transform: translateY(20px); transition: 0.2s; box-shadow: 10px 10px 0px #000;
      position: relative;
    }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px dashed var(--ink); padding-bottom: 10px; }
    .modal-close { background: none; border: none; font-size: 24px; font-weight: 900; cursor: pointer; color: var(--ink); }

    /* Profile Split */
    .split { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
    .avatarPreview { width: 80px; height: 80px; border-radius: var(--radius); border: var(--border-thin); overflow: hidden; background: #fff; flex: 0 0 auto; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
    .avatarPreview img { width: 100%; height: 100%; object-fit: cover; }
  </style>
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div class="loader-overlay" id="globalLoader">
    <div class="spinner"></div>
    <h3 style="margin-top: 20px; font-weight: 900;" id="loaderText">Paketleniyor...</h3>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toast-container"></div>

  <div class="container">
    <div class="panel">
      
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="brand"><i class="fa-solid fa-box-open"></i> EVO CARDBOARD</div>
        <div style="display: flex; gap: 10px;">
          <a class="btn btn-outline" href="index.html" target="_blank"><i class="fa-solid fa-globe"></i> Siteye Git</a>
          <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="appAuth.logout()"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</button>
        </div>
      </div>

      <!-- LOGIN VIEW -->
      <div class="content" id="loginView">
        <div class="login-wrapper">
          <div class="card login-box">
            <div class="tape"></div>
            <div class="login-icon"><i class="fa-solid fa-user-ninja"></i></div>
            <h2>Yetkili Girişi</h2>
            <p style="color:var(--ink-light); font-size:14px; font-weight:600; margin: 10px 0 20px;">Sadece Admin Yetkisi Olanlar</p>
            
            <div class="form-group" style="text-align: left;">
              <label>Kullanıcı E-Mail</label>
              <input type="text" id="loginEmail" placeholder="admin@evostudios.com">
            </div>
            <div class="form-group" style="text-align: left;">
              <label>Kasa Şifresi</label>
              <input type="password" id="loginPass" placeholder="••••••••">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="appAuth.login()">KİLİDİ AÇ <i class="fa-solid fa-key"></i></button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD VIEW -->
      <div class="content" id="dashView" style="display:none;">
        <div class="grid">

          <!-- PROFILE CARD -->
          <div class="card">
            <div class="tape"></div>
            <div class="card-header">
              <h2><i class="fa-solid fa-id-card text-accent"></i> Profil Ayarları</h2>
              <p>Site "About" kısmında görünecek kimlik bilgilerin.</p>
            </div>
            
            <div class="split" style="margin-bottom: 15px;">
              <div class="avatarPreview"><img id="avatarPreview" src="evo_logo.png" alt="Avatar"></div>
              <div style="flex:1; min-width:200px;">
                <label>Görünen İsim</label>
                <input type="text" id="pName" placeholder="Örn: EVO" />
                <label style="margin-top:10px;">Kullanıcı Adı</label>
                <input type="text" id="pHandle" placeholder="Örn: @EvoStudios" />
              </div>
            </div>
            <div class="form-group">
              <label>Avatar URL</label>
              <input type="text" id="pAvatar" placeholder="https://..." oninput="document.getElementById('avatarPreview').src=this.value || 'evo_logo.png';" />
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" style="flex:1;" onclick="appData.saveProfile()"><i class="fa-solid fa-floppy-disk"></i> Profili Kaydet</button>
            </div>
          </div>

          <!-- SYSTEM NOTES / EXPORT -->
          <div class="card">
            <div class="tape"></div>
            <div class="card-header">
              <h2><i class="fa-solid fa-truck-ramp-box"></i> Kargo & Yedekleme</h2>
              <p>Sistemin genel ayarları ve veri yedeklemeleri.</p>
            </div>
            <p style="font-size: 13px; font-weight: 600; color: var(--ink-light); margin-bottom: 15px; line-height: 1.5;">
              <i class="fa-solid fa-shield-halved"></i> <b>Güvenlik Aktif:</b> Supabase V2 sistemi çalışıyor. <br>
              Dosyalar otomatik olarak <b>'evo'</b> bucket'ına depolanır. Sızıntı koruması devrede.
            </p>
            
            <div class="btn-row" style="flex-wrap: wrap;">
              <button class="btn btn-outline" onclick="appData.exportBackup()"><i class="fa-solid fa-box-archive"></i> Tüm Veriyi İndir (Yedek)</button>
              <label class="btn btn-outline" style="cursor:pointer; flex:1; text-align: center;">
                <i class="fa-solid fa-file-import"></i> Yedek Yükle
                <input type="file" accept="application/json" style="display:none" onchange="appData.importBackup(event)" />
              </label>
            </div>
          </div>

          <!-- MODELS MANAGER -->
          <div class="card" id="modelAddCard"> <!-- ID eklendi (Hata için fix) -->
            <div class="tape"></div>
            <div class="card-header">
              <h2><i class="fa-solid fa-cubes"></i> Ücretsiz Modeller</h2>
              <p>Oyuncular için paylaşılacak yeni kutular.</p>
            </div>
            
            <div class="form-group">
              <label>Model Adı (Zorunlu)</label>
              <input type="text" id="mTitle" placeholder="Örn: Sci-Fi Weapon Pack">
            </div>

            <div style="display: flex; gap: 15px;">
              <div class="form-group" style="flex:1;">
                <label>Görsel Seç</label>
                <div class="file-upload">
                  <i class="fa-solid fa-camera"></i> PC'den Seç
                  <input type="file" id="mThumbFile" accept="image/png, image/jpeg, image/webp" onchange="uiManager.updateFileName(this, 'mThumbName')">
                  <div class="file-name-display" id="mThumbName">Seçilmedi</div>
                </div>
              </div>
              <div class="form-group" style="flex:1;">
                <label>Dosya (.rbxm, .zip)</label>
                <div class="file-upload">
                  <i class="fa-solid fa-file-zipper"></i> PC'den Seç
                  <input type="file" id="mFile" onchange="uiManager.updateFileName(this, 'mFileName')">
                  <div class="file-name-display" id="mFileName">Seçilmedi</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Dış Link (Dosya yoksa)</label>
              <input type="text" id="mLink" placeholder="https://create.roblox.com/...">
            </div>

            <div class="form-group">
              <label>Etiket / Kısa Not</label>
              <input type="text" id="mNote" placeholder="Örn: Scriptli, Part Based">
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="appData.addModel()"><i class="fa-solid fa-plus"></i> Modeli Kutula (Yayınla)</button>

            <!-- Models List -->
            <div class="list-container" id="modelsList"></div>
          </div>

          <!-- FEED MANAGER -->
          <div class="card" id="feedAddCard"> <!-- ID eklendi (Hata için fix) -->
            <div class="tape"></div>
            <div class="card-header">
              <h2><i class="fa-solid fa-bullhorn"></i> Duyuru Panosu</h2>
              <p>Kullanıcılara gösterilecek haber ve sızıntılar.</p>
            </div>

            <div class="form-group">
              <label>Başlık (Zorunlu)</label>
              <input type="text" id="fTitle" placeholder="Örn: Evo Update v2 Geliyor!">
            </div>

            <div class="form-group">
              <label>Detaylar (Zorunlu)</label>
              <textarea id="fContent" placeholder="Büyük haberi buraya yaz..."></textarea>
            </div>

            <div style="display: flex; gap: 15px;">
              <div class="form-group" style="flex:1;">
                <label>Kategori</label>
                <select id="fTag">
                  <option value="info">Info / Haber</option>
                  <option value="update">Güncelleme</option>
                  <option value="leak">Sızıntı (Leak)</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label>Medya Ekle</label>
                <div class="file-upload">
                  <i class="fa-solid fa-photo-film"></i> PC'den Seç
                  <input type="file" id="fMediaFile" accept="image/*, video/mp4" onchange="uiManager.updateFileName(this, 'fMediaName')">
                  <div class="file-name-display" id="fMediaName">Seçilmedi</div>
                </div>
              </div>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="fPinned" style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--ink);">
              <label style="margin:0; cursor: pointer;" for="fPinned">Bunu tahtanın en üstüne iğnele</label>
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="appData.addFeed()"><i class="fa-solid fa-thumbtack"></i> Panoya As</button>

            <!-- Feed List -->
            <div class="list-container" id="feedList"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- EDIT MODEL MODAL -->
  <div class="modal-overlay" id="editModelModal">
    <div class="modal-content">
      <div class="tape"></div>
      <div class="modal-header">
        <h3>Modeli Düzenle</h3>
        <button class="modal-close" onclick="uiManager.closeModal('editModelModal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="editModelId">
      <div class="form-group">
        <label>Başlık</label>
        <input type="text" id="emTitle">
      </div>
      <div class="form-group">
        <label>Etiket</label>
        <input type="text" id="emNote">
      </div>
      <div class="form-group">
        <label>Dış Link</label>
        <input type="text" id="emLink">
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="appData.saveEditModel()" style="flex:1;">Kaydet</button>
        <button class="btn btn-outline" onclick="uiManager.closeModal('editModelModal')" style="flex:1;">İptal</button>
      </div>
    </div>
  </div>

  <!-- EDIT FEED MODAL -->
  <div class="modal-overlay" id="editFeedModal">
    <div class="modal-content">
      <div class="tape"></div>
      <div class="modal-header">
        <h3>Postu Düzenle</h3>
        <button class="modal-close" onclick="uiManager.closeModal('editFeedModal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="editFeedId">
      <div class="form-group">
        <label>Başlık</label>
        <input type="text" id="efTitle">
      </div>
      <div class="form-group">
        <label>İçerik</label>
        <textarea id="efContent"></textarea>
      </div>
      <div class="form-group" style="display: flex; gap: 10px; align-items:center;">
        <input type="checkbox" id="efPinned" style="width: 20px; height: 20px; accent-color: var(--ink);">
        <label style="margin:0;">En Üste İğnele</label>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="appData.saveEditFeed()" style="flex:1;">Kaydet</button>
        <button class="btn btn-outline" onclick="uiManager.closeModal('editFeedModal')" style="flex:1;">İptal</button>
      </div>
    </div>
  </div>

<script>
/**
 * EVO DASHBOARD - CARDBOARD EDITION
 * Tamamen güvenli, XSS korumalı, Supabase V2 tabanlı.
 */

const CONFIG = {
  SUPABASE_URL: "https://ixvovmragysxwbcspixo.supabase.co",
  SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4dm92bXJhZ3lzeHdiY3NwaXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNzg3NDMsImV4cCI6MjA4Nzc1NDc0M30.mIMKSz5Jaxxm355NfMWYwP76GFlEQMaifkuyeNSIkPs",
  BUCKET_NAME: "evo", 
  PROFILE_KEY: "evo_profile_v1" 
};

const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

let STATE = { models: [], feeds: [] };

// --- UTILITIES ---
const utils = {
  escapeHTML: (str) => String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"),
  formatBytes: (bytes) => {
    if (!+bytes) return '0 B';
    const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${['B', 'KB', 'MB', 'GB'][i]}`;
  },
  generateFileName: (name) => `${Date.now()}_${Math.random().toString(36).substr(2,6)}_${name.replace(/[^a-zA-Z0-9.-]/g, "")}`
};

// --- UI MANAGER ---
const uiManager = {
  showLoader: (text) => { document.getElementById('loaderText').innerText = text; document.getElementById('globalLoader').style.display = 'flex'; },
  hideLoader: () => { document.getElementById('globalLoader').style.display = 'none'; },
  toast: (msg, type = "success") => {
    const cont = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast`;
    t.style.borderLeftColor = type === 'success' ? 'var(--marker-green)' : 'var(--marker-red)';
    t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-circle-check':'fa-triangle-exclamation'}" style="color:${type==='success'?'var(--marker-green)':'var(--marker-red)'}; font-size:18px;"></i> <span>${utils.escapeHTML(msg)}</span>`;
    cont.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3500);
  },
  switchView: (v) => {
    document.getElementById('loginView').style.display = v === 'login' ? 'block' : 'none';
    document.getElementById('dashView').style.display = v === 'dash' ? 'block' : 'none';
    document.getElementById('logoutBtn').style.display = v === 'dash' ? 'block' : 'none';
  },
  updateFileName: (inp, did) => {
    const d = document.getElementById(did);
    if(inp.files[0]){ d.innerText = inp.files[0].name; d.style.color='var(--marker-green)'; }
    else { d.innerText = "Seçilmedi"; d.style.color='var(--marker-blue)'; }
  },
  openModal: (id) => document.getElementById(id).classList.add('active'),
  closeModal: (id) => document.getElementById(id).classList.remove('active'),
  
  // FIX EKLENEN KISIM: document.getElementById null dönerse işlem yapmaz. (Crash koruması)
  clearInputs: (id) => {
    const c = document.getElementById(id);
    if (!c) return; 
    c.querySelectorAll('input[type="text"], input[type="file"], textarea').forEach(e=>e.value='');
    c.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=false);
    c.querySelectorAll('.file-name-display').forEach(e=>{e.innerText="Seçilmedi"; e.style.color='var(--marker-blue)';});
  }
};

// --- AUTH ---
const appAuth = {
  checkSession: async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) { uiManager.switchView('dash'); appData.initDash(); } 
    else { uiManager.switchView('login'); }
  },
  login: async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    if(!email || !pass) return uiManager.toast('Bilgileri eksik girdin.', 'error');
    
    uiManager.showLoader('Kilidi açılıyor...');
    const { error } = await sb.auth.signInWithPassword({ email, password: pass });
    uiManager.hideLoader();

    if(error) uiManager.toast('Hatalı giriş: ' + error.message, 'error');
    else { uiManager.toast('Kasa açıldı!'); document.getElementById('loginPass').value=''; uiManager.switchView('dash'); appData.initDash(); }
  },
  logout: async () => { await sb.auth.signOut(); uiManager.switchView('login'); uiManager.toast('Çıkış yapıldı.'); }
};

// --- DATA ---
const appData = {
  initDash: () => { appData.loadProfile(); appData.fetchAll(); },

  // PROFILE SYSTEM
  loadProfile: () => {
    try {
      const p = JSON.parse(localStorage.getItem(CONFIG.PROFILE_KEY)) || {};
      document.getElementById("pName").value = p.displayName || "EVO";
      document.getElementById("pHandle").value = p.handle || "@EvoStudios";
      document.getElementById("pAvatar").value = p.avatarUrl || "";
      document.getElementById("avatarPreview").src = p.avatarUrl || "evo_logo.png";
    } catch(e){}
  },
  saveProfile: () => {
    const payload = {
      displayName: document.getElementById("pName").value.trim(),
      handle: document.getElementById("pHandle").value.trim(),
      avatarUrl: document.getElementById("pAvatar").value.trim()
    };
    localStorage.setItem(CONFIG.PROFILE_KEY, JSON.stringify(payload));
    uiManager.toast("Kimlik güncellendi!");
  },

  // BACKUP SYSTEM
  exportBackup: () => {
    const data = { profile: JSON.parse(localStorage.getItem(CONFIG.PROFILE_KEY)), models: STATE.models, feeds: STATE.feeds };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = `evo_backup_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
    uiManager.toast("Yedek indirildi.");
  },
  importBackup: async (e) => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const data = JSON.parse(reader.result);
        if(data.profile) localStorage.setItem(CONFIG.PROFILE_KEY, JSON.stringify(data.profile));
        uiManager.toast("Veri aktarıldı, profili kontrol et."); appData.loadProfile();
      } catch(err) { uiManager.toast("Bozuk JSON dosyası.", "error"); }
    };
    reader.readAsText(file); e.target.value = "";
  },

  // STORAGE UPLOAD
  uploadFile: async (file, folder) => {
    if(!file) return null;
    const path = `${folder}/${utils.generateFileName(file.name)}`;
    const { error } = await sb.storage.from(CONFIG.BUCKET_NAME).upload(path, file);
    if(error) throw error;
    const { data } = sb.storage.from(CONFIG.BUCKET_NAME).getPublicUrl(path);
    return { url: data.publicUrl, name: file.name, size: file.size };
  },

  // FETCH ALL
  fetchAll: async () => {
    uiManager.showLoader('Kutular sayılıyor...');
    try {
      const [mRes, fRes] = await Promise.all([
        sb.from('models').select('*').order('created_at', { ascending: false }),
        sb.from('feed_posts').select('*').order('pinned', { ascending: false }).order('created_at', { ascending: false })
      ]);
      if(mRes.error) throw mRes.error; if(fRes.error) throw fRes.error;
      STATE.models = mRes.data || []; STATE.feeds = fRes.data || [];
      renderEngine.models(); renderEngine.feeds();
    } catch (e) { uiManager.toast('Veri hatası: ' + e.message, 'error'); }
    uiManager.hideLoader();
  },

  // MODELS
  addModel: async () => {
    const title = document.getElementById('mTitle').value.trim();
    if(!title) return uiManager.toast('İsim yazmalısın!', 'error');
    
    uiManager.showLoader('Koli bantlanıyor...');
    try {
      let tUrl="", fUrl="", fName="", fSize="";
      const tFile = document.getElementById('mThumbFile').files[0];
      const mFile = document.getElementById('mFile').files[0];
      
      if(tFile) tUrl = (await appData.uploadFile(tFile, 'model_thumbs')).url;
      if(mFile) {
        const up = await appData.uploadFile(mFile, 'model_files');
        fUrl = up.url; fName = up.name; fSize = utils.formatBytes(up.size);
      }

      await sb.from('models').insert({
        title, note: document.getElementById('mNote').value.trim() || 'Free Model',
        roblox_link: document.getElementById('mLink').value.trim(),
        thumb_url: tUrl, file_url: fUrl, file_name: fName, file_size: fSize
      });
      uiManager.toast('Model paylaşıldı!'); 
      uiManager.clearInputs('modelAddCard'); // FIX EKLENEN KISIM
      appData.fetchAll();
    } catch(e) { uiManager.toast('Hata: '+e.message, 'error'); }
    uiManager.hideLoader();
  },
  deleteModel: async (id) => {
    if(!confirm('Çöpe atılsın mı?')) return;
    uiManager.showLoader('İmha ediliyor...');
    await sb.from('models').delete().eq('id', id);
    uiManager.toast('Silindi.'); appData.fetchAll();
  },
  openEditModel: (id) => {
    const m = STATE.models.find(x => x.id === id); if(!m) return;
    document.getElementById('editModelId').value = m.id;
    document.getElementById('emTitle').value = m.title||'';
    document.getElementById('emNote').value = m.note||'';
    document.getElementById('emLink').value = m.roblox_link||'';
    uiManager.openModal('editModelModal');
  },
  saveEditModel: async () => {
    uiManager.showLoader('Güncelleniyor...');
    await sb.from('models').update({
      title: document.getElementById('emTitle').value.trim(),
      note: document.getElementById('emNote').value.trim(),
      roblox_link: document.getElementById('emLink').value.trim()
    }).eq('id', document.getElementById('editModelId').value);
    uiManager.toast('Güncellendi'); uiManager.closeModal('editModelModal'); appData.fetchAll();
  },

  // FEEDS
  addFeed: async () => {
    const title = document.getElementById('fTitle').value.trim();
    const content = document.getElementById('fContent').value.trim();
    if(!title || !content) return uiManager.toast('Başlık ve yazı eksik!', 'error');

    uiManager.showLoader('Panoya asılıyor...');
    try {
      let mUrl=""; const mFile = document.getElementById('fMediaFile').files[0];
      if(mFile) mUrl = (await appData.uploadFile(mFile, mFile.type.startsWith('video/')?'feed_videos':'feed_images')).url;

      await sb.from('feed_posts').insert({
        title, content, tag: document.getElementById('fTag').value,
        pinned: document.getElementById('fPinned').checked, media_url: mUrl,
        author: "Admin", avatar_url: "evo_logo.png"
      });
      uiManager.toast('Post paylaşıldı!'); 
      uiManager.clearInputs('feedAddCard'); // FIX EKLENEN KISIM
      appData.fetchAll();
    } catch(e) { uiManager.toast('Hata: '+e.message, 'error'); }
    uiManager.hideLoader();
  },
  deleteFeed: async (id) => {
    if(!confirm('Postu yırtıp atalım mı?')) return;
    uiManager.showLoader('Yırtılıyor...');
    await sb.from('feed_posts').delete().eq('id', id);
    uiManager.toast('Yok edildi.'); appData.fetchAll();
  },
  openEditFeed: (id) => {
    const f = STATE.feeds.find(x => x.id === id); if(!f) return;
    document.getElementById('editFeedId').value = f.id;
    document.getElementById('efTitle').value = f.title||'';
    document.getElementById('efContent').value = f.content||'';
    document.getElementById('efPinned').checked = !!f.pinned;
    uiManager.openModal('editFeedModal');
  },
  saveEditFeed: async () => {
    uiManager.showLoader('Güncelleniyor...');
    await sb.from('feed_posts').update({
      title: document.getElementById('efTitle').value.trim(),
      content: document.getElementById('efContent').value.trim(),
      pinned: document.getElementById('efPinned').checked
    }).eq('id', document.getElementById('editFeedId').value);
    uiManager.toast('Güncellendi'); uiManager.closeModal('editFeedModal'); appData.fetchAll();
  }
};

// --- RENDER ENGINE ---
const renderEngine = {
  models: () => {
    const list = document.getElementById('modelsList'); list.innerHTML = '';
    if(!STATE.models.length) return list.innerHTML = '<div style="font-weight:700; opacity:0.5;">Model kutusu boş.</div>';
    
    STATE.models.forEach(m => {
      const t = m.thumb_url || 'https://via.placeholder.com/100/2b1f1a/ffffff?text=X';
      list.innerHTML += `
        <div class="item">
          <div class="item-thumb"><img src="${utils.escapeHTML(t)}" onerror="this.src='https://via.placeholder.com/100'"></div>
          <div class="item-info">
            <div class="item-title">${utils.escapeHTML(m.title)}</div>
            <div class="item-meta">${utils.escapeHTML(m.note||'Model')} • ${new Date(m.created_at).toLocaleDateString()}</div>
            ${m.file_url ? `<div class="item-badge"><i class="fa-solid fa-file-zipper"></i> ${utils.escapeHTML(m.file_name||'Dosya')} (${utils.escapeHTML(m.file_size)})</div>` : ''}
            ${m.roblox_link ? `<div class="item-badge" style="background:var(--tape-bg);"><i class="fa-solid fa-link"></i> Roblox Linki</div>` : ''}
          </div>
          <div class="item-actions">
            <button class="btn-icon btn-edit" onclick="appData.openEditModel('${m.id}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-icon btn-del" onclick="appData.deleteModel('${m.id}')"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>`;
    });
  },
  feeds: () => {
    const list = document.getElementById('feedList'); list.innerHTML = '';
    if(!STATE.feeds.length) return list.innerHTML = '<div style="font-weight:700; opacity:0.5;">Pano bomboş.</div>';

    STATE.feeds.forEach(f => {
      const icon = f.tag==='update' ? 'fa-bolt text-warning' : (f.tag==='leak' ? 'fa-eye text-danger' : 'fa-bullhorn');
      list.innerHTML += `
        <div class="item">
          <div class="item-thumb" style="background:#fff;"><i class="fa-solid ${icon}" style="color:var(--ink);"></i></div>
          <div class="item-info">
            <div class="item-title">${utils.escapeHTML(f.title)}</div>
            <div class="item-meta">${new Date(f.created_at).toLocaleString()}</div>
            ${f.pinned ? `<div class="item-badge" style="background:var(--marker-yellow); border:none; color:#fff;"><i class="fa-solid fa-thumbtack"></i> İğneli</div>` : ''}
            ${f.media_url ? `<div class="item-badge"><i class="fa-solid fa-photo-film"></i> Medya Var</div>` : ''}
          </div>
          <div class="item-actions">
            <button class="btn-icon btn-edit" onclick="appData.openEditFeed('${f.id}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-icon btn-del" onclick="appData.deleteFeed('${f.id}')"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>`;
    });
  }
};

// Start
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginPass').addEventListener('keypress', e => e.key === 'Enter' && appAuth.login());
  appAuth.checkSession();
});
</script>
</body>
</html>
