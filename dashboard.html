<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Evo Studios | Admin Secure Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-panel: #1e293b;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #e2e8f0;
      --radius-lg: 20px;
      --radius-md: 12px;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
      background-image: radial-gradient(circle at top right, rgba(99, 102, 241, 0.15), transparent 40%),
                        radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.1), transparent 40%);
    }

    /* Typography */
    h1, h2, h3 { font-family: 'Outfit', sans-serif; font-weight: 800; color: var(--text-main); }
    
    /* Layout */
    .container { width: 100%; max-width: 1200px; }
    
    .panel {
      background: #f8fafc;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 90vh;
    }

    .topbar {
      background: #ffffff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .brand { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .brand i { color: var(--accent); }

    .content { padding: 30px; flex: 1; overflow-y: auto; }
    
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
    @media(max-width: 768px) { .grid { grid-template-columns: 1fr; } }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 25px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      position: relative;
    }
    
    .card-header { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }
    .card-header p { color: var(--text-muted); font-size: 13px; margin-top: 5px; }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #334155; }
    
    input[type="text"], input[type="password"], select, textarea {
      width: 100%; padding: 12px 15px; border: 2px solid var(--border);
      border-radius: var(--radius-md); font-family: 'Inter', sans-serif;
      font-size: 14px; transition: 0.2s; outline: none; background: #f8fafc;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: #fff; box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
    textarea { min-height: 100px; resize: vertical; }

    /* File Input Styling */
    .file-upload {
      border: 2px dashed var(--border); border-radius: var(--radius-md);
      padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
      background: #f8fafc; position: relative; overflow: hidden;
    }
    .file-upload:hover { border-color: var(--accent); background: #e0e7ff; }
    .file-upload input[type="file"] {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; cursor: pointer;
    }
    .file-name-display { font-size: 12px; color: var(--accent); font-weight: 600; margin-top: 5px; word-break: break-all;}

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 18px; border-radius: var(--radius-md); font-weight: 600;
      font-size: 14px; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none;
    }
    .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(99,102,241,0.3); }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .btn-danger { background: #fee2e2; color: var(--danger); }
    .btn-danger:hover { background: #fecaca; }
    .btn-outline { border: 2px solid var(--border); background: transparent; color: var(--text-main); }
    .btn-outline:hover { background: #f1f5f9; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-row { display: flex; gap: 10px; margin-top: 20px; }

    /* Lists & Items */
    .list-container { margin-top: 20px; max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; }
    .list-container::-webkit-scrollbar { width: 6px; }
    .list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    .item {
      display: flex; gap: 15px; background: #f8fafc; border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 12px; align-items: center; transition: 0.2s;
    }
    .item:hover { border-color: #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    
    .item-thumb {
      width: 60px; height: 60px; border-radius: 8px; background: var(--bg-dark);
      flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
    }
    .item-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .item-thumb i { font-size: 24px; color: white; }
    
    .item-info { flex: 1; min-width: 0; }
    .item-title { font-weight: 700; font-size: 15px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-meta { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .item-badge { display: inline-block; padding: 2px 8px; background: #e0e7ff; color: var(--accent); border-radius: 20px; font-size: 11px; font-weight: 700; margin-left: 5px; }

    .item-actions { display: flex; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-edit { background: #e0f2fe; color: #0284c7; }
    .btn-edit:hover { background: #bae6fd; }
    .btn-del { background: #fee2e2; color: #ef4444; }
    .btn-del:hover { background: #fecaca; }

    /* Login Screen */
    .login-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; padding: 20px; }
    .login-box { width: 100%; max-width: 400px; text-align: center; }
    .login-icon { font-size: 48px; color: var(--accent); margin-bottom: 20px; }

    /* Loading Overlay */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; display: none;
    }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Toast Notification */
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: white; border-left: 4px solid var(--accent); padding: 15px 20px;
      border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px;
      animation: slideIn 0.3s forwards;
    }
    .toast.error { border-color: var(--danger); color: var(--danger); }
    .toast.success { border-color: var(--success); color: var(--success); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: white; width: 100%; max-width: 500px; border-radius: var(--radius-lg);
      padding: 30px; transform: translateY(20px); transition: 0.3s; box-shadow: var(--shadow);
    }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-muted); }
  </style>
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div class="loader-overlay" id="globalLoader">
    <div class="spinner"></div>
    <h3 style="margin-top: 15px; color: var(--accent);" id="loaderText">İşleniyor...</h3>
  </div>

  <!-- TOAST CONTAINER -->
  <div id="toast-container"></div>

  <div class="container">
    <div class="panel">
      
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="brand"><i class="fa-solid fa-shield-halved"></i> EVO Admin Space</div>
        <div>
          <a class="btn btn-outline" href="index.html" target="_blank"><i class="fa-solid fa-globe"></i> Siteyi Gör</a>
          <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="appAuth.logout()"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</button>
        </div>
      </div>

      <!-- LOGIN VIEW -->
      <div class="content" id="loginView">
        <div class="login-wrapper">
          <div class="card login-box">
            <div class="login-icon"><i class="fa-solid fa-user-lock"></i></div>
            <h2>Güvenli Giriş</h2>
            <p style="color:var(--text-muted); font-size:14px; margin: 10px 0 20px;">Sadece yetkili personeller içindir.</p>
            
            <div class="form-group" style="text-align: left;">
              <label>Admin E-Mail</label>
              <input type="text" id="loginEmail" placeholder="admin@evostudios.com">
            </div>
            <div class="form-group" style="text-align: left;">
              <label>Şifre</label>
              <input type="password" id="loginPass" placeholder="••••••••">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="appAuth.login()">Giriş Yap <i class="fa-solid fa-arrow-right"></i></button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD VIEW -->
      <div class="content" id="dashView" style="display:none;">
        <div class="grid">

          <!-- MODELS MANAGER -->
          <div class="card">
            <div class="card-header">
              <h2><i class="fa-solid fa-cube text-accent"></i> Model Yönetimi</h2>
              <p>Siteye ücretsiz model ve dosya ekleyin.</p>
            </div>
            
            <div class="form-group">
              <label>Model Adı (Zorunlu)</label>
              <input type="text" id="mTitle" placeholder="Örn: Sci-Fi Weapon Pack">
            </div>

            <div style="display: flex; gap: 15px;">
              <div class="form-group" style="flex:1;">
                <label>Görsel (Thumbnail) Seç</label>
                <div class="file-upload">
                  <i class="fa-solid fa-image"></i> PC'den Seç
                  <input type="file" id="mThumbFile" accept="image/png, image/jpeg, image/webp" onchange="uiManager.updateFileName(this, 'mThumbName')">
                  <div class="file-name-display" id="mThumbName">Seçilmedi</div>
                </div>
              </div>
              <div class="form-group" style="flex:1;">
                <label>Model Dosyası (.rbxm, .zip)</label>
                <div class="file-upload">
                  <i class="fa-solid fa-file-zipper"></i> PC'den Seç
                  <input type="file" id="mFile" onchange="uiManager.updateFileName(this, 'mFileName')">
                  <div class="file-name-display" id="mFileName">Seçilmedi</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Alternatif Link (Opsiyonel - Dosya yüklenmezse kullanılır)</label>
              <input type="text" id="mLink" placeholder="https://create.roblox.com/...">
            </div>

            <div class="form-group">
              <label>Kısa Not / Etiket</label>
              <input type="text" id="mNote" placeholder="Örn: Part Based, Scripted">
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="appData.addModel()"><i class="fa-solid fa-plus"></i> Modeli Yayınla</button>

            <!-- Models List -->
            <div class="list-container" id="modelsList">
              <!-- Rendered via JS -->
            </div>
          </div>

          <!-- FEED MANAGER -->
          <div class="card">
            <div class="card-header">
              <h2><i class="fa-solid fa-rss" style="color:var(--warning)"></i> Feed & Duyurular</h2>
              <p>Oyunculara yenilikleri ve sızıntıları duyurun.</p>
            </div>

            <div class="form-group">
              <label>Başlık (Zorunlu)</label>
              <input type="text" id="fTitle" placeholder="Örn: Evo Update v2 Geliyor!">
            </div>

            <div class="form-group">
              <label>İçerik (Zorunlu)</label>
              <textarea id="fContent" placeholder="Duyuru detaylarını buraya yazın..."></textarea>
            </div>

            <div style="display: flex; gap: 15px;">
              <div class="form-group" style="flex:1;">
                <label>Kategori (Etiket)</label>
                <select id="fTag">
                  <option value="info">Info / Haber</option>
                  <option value="update">Güncelleme</option>
                  <option value="leak">Sızıntı (Leak)</option>
                </select>
              </div>
              <div class="form-group" style="flex:1;">
                <label>Görsel/Video Yükle</label>
                <div class="file-upload">
                  <i class="fa-solid fa-photo-film"></i> PC'den Seç
                  <input type="file" id="fMediaFile" accept="image/*, video/mp4" onchange="uiManager.updateFileName(this, 'fMediaName')">
                  <div class="file-name-display" id="fMediaName">Seçilmedi</div>
                </div>
              </div>
            </div>

            <div class="form-group" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="fPinned" style="width: 20px; height: 20px; cursor: pointer;">
              <label style="margin:0; cursor: pointer;" for="fPinned">Bu postu en başa tuttur (Pinned)</label>
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="appData.addFeed()"><i class="fa-solid fa-paper-plane"></i> Post Paylaş</button>

            <!-- Feed List -->
            <div class="list-container" id="feedList">
              <!-- Rendered via JS -->
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- EDIT MODEL MODAL -->
  <div class="modal-overlay" id="editModelModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Modeli Düzenle</h3>
        <button class="modal-close" onclick="uiManager.closeModal('editModelModal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="editModelId">
      <div class="form-group">
        <label>Başlık</label>
        <input type="text" id="emTitle">
      </div>
      <div class="form-group">
        <label>Not</label>
        <input type="text" id="emNote">
      </div>
      <div class="form-group">
        <label>Dış Link (Varsa)</label>
        <input type="text" id="emLink">
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="appData.saveEditModel()" style="flex:1;">Kaydet</button>
        <button class="btn btn-outline" onclick="uiManager.closeModal('editModelModal')" style="flex:1;">İptal</button>
      </div>
      <p style="font-size: 11px; color:gray; margin-top:10px;">*Not: Dosyaları değiştirmek için modeli silip tekrar yüklemeniz önerilir.</p>
    </div>
  </div>

  <!-- EDIT FEED MODAL -->
  <div class="modal-overlay" id="editFeedModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Postu Düzenle</h3>
        <button class="modal-close" onclick="uiManager.closeModal('editFeedModal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input type="hidden" id="editFeedId">
      <div class="form-group">
        <label>Başlık</label>
        <input type="text" id="efTitle">
      </div>
      <div class="form-group">
        <label>İçerik</label>
        <textarea id="efContent"></textarea>
      </div>
      <div class="form-group" style="display: flex; gap: 10px; align-items:center;">
        <input type="checkbox" id="efPinned" style="width: 18px; height: 18px;">
        <label style="margin:0;">Başa Tuttur</label>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="appData.saveEditFeed()" style="flex:1;">Kaydet</button>
        <button class="btn btn-outline" onclick="uiManager.closeModal('editFeedModal')" style="flex:1;">İptal</button>
      </div>
    </div>
  </div>

<script>
/**
 * EVO DASHBOARD V2.0 - SECURE & REFACTORED
 * Geliştirici: AI
 */

// ==========================================
// CONFIG & SUPABASE (BURAYI KENDİ BİLGİLERİNLE DOLDUR)
// ==========================================
const CONFIG = {
  SUPABASE_URL: "https://ixvovmragysxwbcspixo.supabase.co",
  SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4dm92bXJhZ3lzeHdiY3NwaXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNzg3NDMsImV4cCI6MjA4Nzc1NDc0M30.mIMKSz5Jaxxm355NfMWYwP76GFlEQMaifkuyeNSIkPs",
  BUCKET_NAME: "assets" // Supabase Storage içindeki public bucket adın
};

const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

// State Management
let STATE = {
  models: [],
  feeds: []
};

// ==========================================
// UTILITY FUNCTIONS (GÜVENLİK VE ARAÇLAR)
// ==========================================
const utils = {
  // XSS Koruması: Ekrana basılan her veriyi temizler
  escapeHTML: (str) => {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  },
  
  // Dosya boyutu hesaplama
  formatBytes: (bytes, decimals = 2) => {
    if (!+bytes) return '0 Bytes';
    const k = 1024, dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
  },

  // Rastgele dosya ismi üretici (Overwrite engellemek için)
  generateFileName: (originalName) => {
    const ext = originalName.split('.').pop();
    const safeName = originalName.replace(/[^a-zA-Z0-9]/g, "").substring(0, 15);
    return `${Date.now()}_${Math.random().toString(36).substring(2,8)}_${safeName}.${ext}`;
  }
};

// ==========================================
// UI MANAGER (Bildirimler, Loader, Modallar)
// ==========================================
const uiManager = {
  showLoader: (text = "İşleniyor...") => {
    document.getElementById('loaderText').innerText = text;
    document.getElementById('globalLoader').style.display = 'flex';
  },
  hideLoader: () => {
    document.getElementById('globalLoader').style.display = 'none';
  },
  toast: (message, type = "success") => {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-circle-exclamation'}"></i> ${utils.escapeHTML(message)}`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
  },
  switchView: (view) => {
    document.getElementById('loginView').style.display = view === 'login' ? 'block' : 'none';
    document.getElementById('dashView').style.display = view === 'dash' ? 'block' : 'none';
    document.getElementById('logoutBtn').style.display = view === 'dash' ? 'inline-flex' : 'none';
  },
  updateFileName: (inputElem, displayId) => {
    const display = document.getElementById(displayId);
    if (inputElem.files && inputElem.files[0]) {
      display.innerText = inputElem.files[0].name;
      display.style.color = 'var(--success)';
    } else {
      display.innerText = "Seçilmedi";
      display.style.color = 'var(--accent)';
    }
  },
  openModal: (id) => document.getElementById(id).classList.add('active'),
  closeModal: (id) => document.getElementById(id).classList.remove('active'),
  clearInputs: (containerId) => {
    const container = document.getElementById(containerId) || document;
    container.querySelectorAll('input[type="text"], input[type="file"], textarea').forEach(el => el.value = '');
    container.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
    container.querySelectorAll('.file-name-display').forEach(el => { el.innerText = "Seçilmedi"; el.style.color = 'var(--accent)'; });
  }
};

// ==========================================
// AUTHENTICATION LOGIC (Supabase Auth)
// ==========================================
const appAuth = {
  checkSession: async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      uiManager.switchView('dash');
      appData.fetchAll(); // Verileri yükle
    } else {
      uiManager.switchView('login');
    }
  },
  login: async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value;
    
    if (!email || !pass) return uiManager.toast('E-mail ve şifre zorunludur.', 'error');
    
    uiManager.showLoader('Giriş yapılıyor...');
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    uiManager.hideLoader();

    if (error) {
      uiManager.toast('Hatalı giriş: ' + error.message, 'error');
    } else {
      uiManager.toast('Başarıyla giriş yapıldı!');
      document.getElementById('loginPass').value = '';
      uiManager.switchView('dash');
      appData.fetchAll();
    }
  },
  logout: async () => {
    await sb.auth.signOut();
    uiManager.switchView('login');
    uiManager.toast('Çıkış yapıldı.');
  }
};

// ==========================================
// DATA & STORAGE LOGIC (Supabase CRUD)
// ==========================================
const appData = {
  
  // YARDIMCI: Dosya Yükleme Motoru
  uploadFileToStorage: async (file, folderName) => {
    if (!file) return null;
    const newName = utils.generateFileName(file.name);
    const path = `${folderName}/${newName}`;
    
    const { data, error } = await sb.storage.from(CONFIG.BUCKET_NAME).upload(path, file);
    if (error) throw error;
    
    const { data: urlData } = sb.storage.from(CONFIG.BUCKET_NAME).getPublicUrl(path);
    return { url: urlData.publicUrl, path: path, name: file.name, size: file.size };
  },

  // Tüm Verileri Çek ve Ekrana Bas
  fetchAll: async () => {
    uiManager.showLoader('Veriler sekronize ediliyor...');
    try {
      // Modelleri Çek
      const { data: mData, error: mErr } = await sb.from('models').select('*').order('created_at', { ascending: false });
      if (mErr) throw mErr;
      STATE.models = mData || [];
      renderEngine.renderModels();

      // Feedleri Çek
      const { data: fData, error: fErr } = await sb.from('feed_posts').select('*').order('pinned', { ascending: false }).order('created_at', { ascending: false });
      if (fErr) throw fErr;
      STATE.feeds = fData || [];
      renderEngine.renderFeeds();
      
    } catch (e) {
      uiManager.toast('Veri çekme hatası: ' + e.message, 'error');
    }
    uiManager.hideLoader();
  },

  // --- MODELS ---
  addModel: async () => {
    const title = document.getElementById('mTitle').value.trim();
    if (!title) return uiManager.toast('Model adı zorunludur!', 'error');

    const fileInput = document.getElementById('mFile').files[0];
    const thumbInput = document.getElementById('mThumbFile').files[0];
    const link = document.getElementById('mLink').value.trim();
    const note = document.getElementById('mNote').value.trim();

    uiManager.showLoader('Dosyalar yükleniyor ve model ekleniyor...');
    try {
      let thumbUrl = "", fileUrl = "", fileName = "", fileSize = "";

      if (thumbInput) {
        uiManager.showLoader('Görsel Yükleniyor...');
        const tData = await appData.uploadFileToStorage(thumbInput, 'model_thumbs');
        thumbUrl = tData.url;
      }
      
      if (fileInput) {
        uiManager.showLoader('Model Dosyası Yükleniyor...');
        const fData = await appData.uploadFileToStorage(fileInput, 'model_files');
        fileUrl = fData.url;
        fileName = fData.name;
        fileSize = utils.formatBytes(fData.size);
      }

      const payload = {
        title: title,
        note: note || "Free Model",
        roblox_link: link,
        thumb_url: thumbUrl,
        file_url: fileUrl,
        file_name: fileName,
        file_size: fileSize
      };

      const { error } = await sb.from('models').insert(payload);
      if (error) throw error;

      uiManager.toast('Model başarıyla eklendi!');
      uiManager.clearInputs('dashView'); // Sadece ilgili alanı temizlemek için geliştirilebilir
      appData.fetchAll(); // Listeyi yenile

    } catch (e) {
      uiManager.toast('Hata: ' + e.message, 'error');
    }
    uiManager.hideLoader();
  },

  deleteModel: async (id) => {
    if(!confirm('Bu modeli kalıcı olarak silmek istiyor musun?')) return;
    uiManager.showLoader('Siliniyor...');
    try {
      const { error } = await sb.from('models').delete().eq('id', id);
      if (error) throw error;
      uiManager.toast('Model silindi.');
      appData.fetchAll();
    } catch (e) {
      uiManager.toast('Silme hatası: ' + e.message, 'error');
    }
    uiManager.hideLoader();
  },

  openEditModel: (id) => {
    const model = STATE.models.find(m => m.id === id);
    if(!model) return;
    document.getElementById('editModelId').value = model.id;
    document.getElementById('emTitle').value = model.title || '';
    document.getElementById('emNote').value = model.note || '';
    document.getElementById('emLink').value = model.roblox_link || '';
    uiManager.openModal('editModelModal');
  },

  saveEditModel: async () => {
    const id = document.getElementById('editModelId').value;
    const title = document.getElementById('emTitle').value.trim();
    const note = document.getElementById('emNote').value.trim();
    const link = document.getElementById('emLink').value.trim();

    if(!title) return uiManager.toast('Başlık boş olamaz', 'error');

    uiManager.showLoader('Güncelleniyor...');
    try {
      const { error } = await sb.from('models').update({
        title: title, note: note, roblox_link: link
      }).eq('id', id);
      if (error) throw error;

      uiManager.toast('Model güncellendi');
      uiManager.closeModal('editModelModal');
      appData.fetchAll();
    } catch (e) {
      uiManager.toast('Güncelleme hatası', 'error');
    }
    uiManager.hideLoader();
  },

  // --- FEEDS ---
  addFeed: async () => {
    const title = document.getElementById('fTitle').value.trim();
    const content = document.getElementById('fContent').value.trim();
    if (!title || !content) return uiManager.toast('Başlık ve içerik zorunludur!', 'error');

    const tag = document.getElementById('fTag').value;
    const pinned = document.getElementById('fPinned').checked;
    const mediaInput = document.getElementById('fMediaFile').files[0];

    uiManager.showLoader('Post hazırlanıyor...');
    try {
      let mediaUrl = "";

      if (mediaInput) {
        uiManager.showLoader('Medya Yükleniyor...');
        const folder = mediaInput.type.startsWith('video/') ? 'feed_videos' : 'feed_images';
        const mData = await appData.uploadFileToStorage(mediaInput, folder);
        mediaUrl = mData.url;
      }

      const payload = {
        title: title,
        content: content,
        tag: tag,
        pinned: pinned,
        media_url: mediaUrl,
        author: "Evo Admin", // Dinamik yapılabilir
        avatar_url: "evo_logo.png"
      };

      const { error } = await sb.from('feed_posts').insert(payload);
      if (error) throw error;

      uiManager.toast('Post paylaşıldı!');
      document.getElementById('fTitle').value = '';
      document.getElementById('fContent').value = '';
      document.getElementById('fPinned').checked = false;
      document.getElementById('fMediaFile').value = '';
      uiManager.updateFileName(document.getElementById('fMediaFile'), 'fMediaName');
      
      appData.fetchAll();

    } catch (e) {
      uiManager.toast('Hata: ' + e.message, 'error');
    }
    uiManager.hideLoader();
  },

  deleteFeed: async (id) => {
    if(!confirm('Bu postu silmek istiyor musun?')) return;
    uiManager.showLoader('Siliniyor...');
    try {
      const { error } = await sb.from('feed_posts').delete().eq('id', id);
      if (error) throw error;
      uiManager.toast('Post silindi.');
      appData.fetchAll();
    } catch (e) {
      uiManager.toast('Silme hatası', 'error');
    }
    uiManager.hideLoader();
  },

  openEditFeed: (id) => {
    const post = STATE.feeds.find(f => f.id === id);
    if(!post) return;
    document.getElementById('editFeedId').value = post.id;
    document.getElementById('efTitle').value = post.title || '';
    document.getElementById('efContent').value = post.content || '';
    document.getElementById('efPinned').checked = !!post.pinned;
    uiManager.openModal('editFeedModal');
  },

  saveEditFeed: async () => {
    const id = document.getElementById('editFeedId').value;
    const title = document.getElementById('efTitle').value.trim();
    const content = document.getElementById('efContent').value.trim();
    const pinned = document.getElementById('efPinned').checked;

    if(!title || !content) return uiManager.toast('Başlık ve içerik gerekli', 'error');

    uiManager.showLoader('Güncelleniyor...');
    try {
      const { error } = await sb.from('feed_posts').update({
        title: title, content: content, pinned: pinned
      }).eq('id', id);
      if (error) throw error;

      uiManager.toast('Post güncellendi');
      uiManager.closeModal('editFeedModal');
      appData.fetchAll();
    } catch (e) {
      uiManager.toast('Hata: ' + e.message, 'error');
    }
    uiManager.hideLoader();
  }
};

// ==========================================
// RENDER ENGINE (HTML OLUŞTURUCU)
// ==========================================
const renderEngine = {
  renderModels: () => {
    const list = document.getElementById('modelsList');
    list.innerHTML = '';
    
    if(STATE.models.length === 0) {
      list.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding: 20px;">Henüz model eklenmedi.</div>';
      return;
    }

    STATE.models.forEach(m => {
      const thumb = m.thumb_url ? m.thumb_url : 'https://via.placeholder.com/100?text=No+Img';
      const fileBadge = m.file_url ? `<span class="item-badge" style="background:#dcfce7; color:#16a34a;"><i class="fa-solid fa-download"></i> İndirilebilir Dosya</span>` : '';
      const linkBadge = m.roblox_link ? `<span class="item-badge"><i class="fa-solid fa-link"></i> Dış Link</span>` : '';
      
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-thumb"><img src="${utils.escapeHTML(thumb)}" onerror="this.src='https://via.placeholder.com/100?text=Error'"></div>
        <div class="item-info">
          <div class="item-title">${utils.escapeHTML(m.title)} ${m.pinned ? '<i class="fa-solid fa-thumbtack text-accent"></i>' : ''}</div>
          <div class="item-meta">${utils.escapeHTML(m.note || 'Genel Model')} • ${new Date(m.created_at).toLocaleDateString()}</div>
          <div style="margin-top: 5px;">${fileBadge} ${linkBadge}</div>
        </div>
        <div class="item-actions">
          <button class="btn-icon btn-edit" title="Düzenle" onclick="appData.openEditModel('${m.id}')"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-icon btn-del" title="Sil" onclick="appData.deleteModel('${m.id}')"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;
      list.appendChild(div);
    });
  },

  renderFeeds: () => {
    const list = document.getElementById('feedList');
    list.innerHTML = '';

    if(STATE.feeds.length === 0) {
      list.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding: 20px;">Henüz duyuru eklenmedi.</div>';
      return;
    }

    STATE.feeds.forEach(f => {
      let icon = 'fa-bullhorn';
      let color = 'var(--accent)';
      if(f.tag === 'update') { icon = 'fa-arrow-up-right-dots'; color = 'var(--success)'; }
      if(f.tag === 'leak') { icon = 'fa-user-secret'; color = 'var(--danger)'; }

      const pinBadge = f.pinned ? `<span class="item-badge" style="background:#fef3c7; color:#d97706;"><i class="fa-solid fa-thumbtack"></i> Başa Tutturuldu</span>` : '';
      const mediaBadge = f.media_url ? `<span class="item-badge"><i class="fa-solid fa-photo-film"></i> Medya Var</span>` : '';

      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-thumb" style="background: ${color};"><i class="fa-solid ${icon}"></i></div>
        <div class="item-info">
          <div class="item-title">${utils.escapeHTML(f.title)}</div>
          <div class="item-meta">${new Date(f.created_at).toLocaleString()}</div>
          <div style="margin-top: 5px;">${pinBadge} ${mediaBadge}</div>
        </div>
        <div class="item-actions">
          <button class="btn-icon btn-edit" title="Düzenle" onclick="appData.openEditFeed('${m.id}' /* HATA DÜZELTMESİ AŞAĞIDA: f.id olmalı */)"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-icon btn-del" title="Sil" onclick="appData.deleteFeed('${f.id}')"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;
      // Ufak typo düzeltmesi için HTML stringini yeniliyorum:
      div.querySelector('.btn-edit').setAttribute('onclick', `appData.openEditFeed('${f.id}')`);
      list.appendChild(div);
    });
  }
};

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
  // Enter tuşu ile giriş yapma
  document.getElementById('loginPass').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') appAuth.login();
  });
  
  // Başlangıçta oturum kontrolü
  appAuth.checkSession();
});

</script>
</body>
</html>
